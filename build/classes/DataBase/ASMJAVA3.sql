/*
Ngay tao 16/7/2022
Kết nối với Asmjav3
*/

CREATE DATABASE STUDENTMANAGER
ON
(
	NAME = STUDENTMANAGER_dat,
	FILENAME = 'D:\JAVA3\STUDENTMANAGER.dat',
	SIZE = 10,
	MAXSIZE = 50,
	FILEGROWTH = 5
)
LOG ON
(
	NAME = STUDENTMANAGER_ldf,
	FILENAME = 'D:\JAVA3\STUDENTMANAGER.ldf',
	SIZE = 10MB,
	MAXSIZE = 50MB,
	FILEGROWTH = 5MB

)
GO
USE STUDENTMANAGER
GO

CREATE TABLE USERS
(
	USERNAME NVARCHAR(10) NOT NULL PRIMARY KEY,
	PASSWORD NVARCHAR(10) ,
	ROLE NVARCHAR(5)
)
GO
CREATE TABLE STUDENTS
(
	MASV NVARCHAR(7) NOT NULL PRIMARY KEY,
	HOTEN NVARCHAR(50),
	EMAIL NVARCHAR(50),
	SODT NVARCHAR(12),
	GIOITINH BIT,
	DIACHI NVARCHAR(100),
	HINH NVARCHAR(50)

)
GO
CREATE TABLE GRADE 
(
	ID INT NOT NULL,
	MASV NVARCHAR(7) REFERENCES STUDENTS(MASV),
	TOAN FLOAT,
	NGUVAN FLOAT,
	TIENGANH FLOAT

)
GO
-- rang buoc duy nhat 1 ma sinh vien có 1 khoa ngoai
ALTER TABLE students ADD CONSTRAINT onlyOne UNIQUE(Masv)
go

-- KHI THEM 1 SV MOI THI SE THEM 1 GRADE CUA SINH VIEN VA 1 ACCOUNT CUA SV VAO USER
CREATE  TRIGGER ADD_ALLACOUNT ON STUDENTS INSTEAD OF INSERT
 AS
 BEGIN 
	INSERT INTO STUDENTS SELECT *  FROM inserted
	-- GIANG VIEN TU UPDATE DIEM THEO QUA TRINH HOC
	INSERT INTO GRADE VALUES ((SELECT MASV FROM inserted),NULL,NULL,NULL)
	-- SINH VIEN CO THE DOI PASS DO TRUONG CAP ACCOUNT
	INSERT INTO USERS VALUES ((SELECT MASV FROM inserted),N'123','sv',(SELECT MASV FROM inserted))
 END
 GO
 -- KHI XOA 1 STUDENT SE XOA ALL THONG TIN LIEN QUAN CUA STUDENT DO
CREATE TRIGGER DELETE_ALLACCOUNT ON STUDENTS INSTEAD OF DELETE
 AS
  BEGIN
	DECLARE @MA NVARCHAR(7)
	SELECT @MA = MASV  FROM deleted
	DELETE FROM USERS WHERE MASV = @MA
	DELETE FROM GRADE WHERE MASV = @MA
	DELETE FROM STUDENTS WHERE MASV = @MA
 END
 GO

 INSERT INTO STUDENTS VALUES (N'PS37775',N'Huỳnh Thị Mỹ Ngọc',N'Ngoc@fpt.edu.vn',N'0377379289',0,N'Quận 1 ,TP HCM',null)

 SELECT * FROM GRADE
 SELECT * FROM STUDENTS
 select * from users
 DELETE FROM STUDENTS WHERE MASV = N'PS37775'


